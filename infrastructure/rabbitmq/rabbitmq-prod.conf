# =============================================================================
# RabbitMQ Production Configuration for IvyArc
# =============================================================================

# Cluster and Node Settings
cluster_formation.peer_discovery_backend = classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq
cluster_name = ivyarc-production

# Network and Connectivity
listeners.tcp.default = 5672
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

# TLS/SSL Configuration (uncomment for production TLS)
# listeners.ssl.default = 5671
# ssl_options.cacertfile = /etc/ssl/rabbitmq/ca.crt
# ssl_options.certfile   = /etc/ssl/rabbitmq/server.crt
# ssl_options.keyfile    = /etc/ssl/rabbitmq/server.key
# ssl_options.verify     = verify_peer
# ssl_options.fail_if_no_peer_cert = true
# ssl_options.versions.1 = tlsv1.2
# ssl_options.versions.2 = tlsv1.3
# ssl_options.honor_cipher_order = true
# ssl_options.honor_ecc_order = true
# management.ssl.port       = 15671
# management.ssl.cacertfile = /etc/ssl/rabbitmq/ca.crt
# management.ssl.certfile   = /etc/ssl/rabbitmq/server.crt
# management.ssl.keyfile    = /etc/ssl/rabbitmq/server.key

# Default Virtual Host and User
default_vhost = ivyarc
default_user = RABBITMQ_USER_PLACEHOLDER
default_pass = RABBITMQ_PASS_PLACEHOLDER

# Permissions
default_permissions.configure = .*
default_permissions.read = .*
default_permissions.write = .*

# User Management
default_user_tags.administrator = true
loopback_users.guest = false

# Memory and Disk Management
vm_memory_high_watermark.relative = 0.5
vm_memory_high_watermark_paging_ratio = 0.75
disk_free_limit.relative = 0.4

# Message TTL and Queue Settings
default_message_ttl = 86400000
queue_master_locator = balanced
queue_index_embed_msgs_below = 4096

# Logging
log.console = true
log.console.level = info
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.size = 100MB
log.file.rotation.count = 30
log.connection.level = info
log.channel.level = info
log.queue.level = info
log.exchange.level = info
log.binding.level = info

# Management Plugin
management.load_definitions = /etc/rabbitmq/definitions.json
management.rates_mode = detailed
management.sample_retention_policies.global.minute = 5
management.sample_retention_policies.global.hour = 60
management.sample_retention_policies.global.day = 1440
management.sample_retention_policies.basic.minute = 5
management.sample_retention_policies.basic.hour = 60
management.sample_retention_policies.detailed.10 = 5

# Heartbeat and Connection Settings
heartbeat = 60
connection_max = 5000
channel_max = 10000
max_message_size = 134217728

# Federation and Shovel
auth_mechanisms.1 = PLAIN
auth_mechanisms.2 = AMQPLAIN
auth_mechanisms.3 = EXTERNAL

# Prometheus Monitoring
prometheus.tcp.port = 15692
prometheus.tcp.ip = 0.0.0.0
prometheus.return_per_object_metrics = true

# Performance Settings
collect_statistics = fine
collect_statistics_interval = 5000
mnesia_table_loading_retry_timeout = 30000
mnesia_table_loading_retry_limit = 10

# Background GC Settings
background_gc_enabled = true
background_gc_target_interval = 60000

# Mirroring Policy (High Availability)
ha_mode = exactly
ha_params = 2
ha_sync_mode = automatic
ha_promote_on_shutdown = when_synced
ha_promote_on_failure = when_synced

# Policy Settings
policy_ttl = 86400000

# Advanced Memory Settings
tcp_listen_options.backlog = 4096
tcp_listen_options.nodelay = true
tcp_listen_options.linger.on = true
tcp_listen_options.linger.timeout = 0
tcp_listen_options.sndbuf = 32768
tcp_listen_options.recbuf = 32768

# Delegate Count (for better performance)
delegate_count = 16

# Lazy Queues (for better memory usage)
queue_index_max_journal_entries = 32768

# Credit Flow (for better flow control)
credit_flow_default_credit = {400, 200}

# Clustering Settings (if using cluster)
cluster_keepalive_interval = 10000
cluster_partition_handling = pause_minority

# MQTT Plugin (if using MQTT)
# mqtt.default_user = mqtt_user
# mqtt.default_pass = mqtt_pass
# mqtt.allow_anonymous = false
# mqtt.vhost = /
# mqtt.tcp_listen_options.backlog = 1024
# mqtt.tcp_listen_options.nodelay = true

# STOMP Plugin (if using STOMP)
# stomp.default_user = stomp_user
# stomp.default_pass = stomp_pass

# Web STOMP Plugin (if using Web STOMP)
# web_stomp.tcp.port = 15674

# LDAP Authentication (if using LDAP)
# auth_backends.1 = rabbit_auth_backend_ldap
# auth_backends.2 = rabbit_auth_backend_internal
# auth_ldap.servers.1 = ldap.example.com
# auth_ldap.port = 389
# auth_ldap.timeout = 5000